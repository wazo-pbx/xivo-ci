#!/bin/bash

ACCEPTANCE_PATH="/data/xivo-acceptance"
FEATURE_NAME=$(echo $JOB_NAME | sed 's/acceptance_//g')

export WORKON_HOME="~/envs"
export PYTHONIOENCODING=UTF-8
export PYTHONPATH=$ACCEPTANCE_PATH

if [ $FEATURE_NAME == 'post_wizard' ]; then
    python ${ACCEPTANCE_PATH}/utils/prerequisite.py
fi

cd $ACCEPTANCE_PATH
git pull
cp -r features/$FEATURE_NAME $WORKSPACE

if [ -f "requirements.txt" ];then
	pip install -r requirements.txt
fi

cd $WORKSPACE

source /usr/local/bin/virtualenvwrapper.sh
workon xivo
lettuce $FEATURE_NAME --with-xunit --verbosity=3 --xunit-file=xunit-tests.xml
deactivate
cp xunit-tests.xml /data/test_results/$JOB_NAME.xml