#!/bin/bash

ACCEPTANCE_PATH="/data/xivo-acceptance"
FEATURE_NAME=$(echo $JOB_NAME | sed 's/acceptance_//g')

export WORKON_HOME="~/envs"
export PYTHONIOENCODING=UTF-8

source /usr/local/bin/virtualenvwrapper.sh
workon xivo

set -e

cd $ACCEPTANCE_PATH
git pull
cp -r features/$FEATURE_NAME $WORKSPACE

cd $WORKSPACE

if [ -f "requirements.txt" ]; then
	pip install --upgrade -r requirements.txt
fi

if [ $FEATURE_NAME == 'post_wizard' ]; then
	prerequisite.py
fi

lettuce $FEATURE_NAME --with-xunit --verbosity=3 --xunit-file=xunit-tests.xml

cp xunit-tests.xml /data/test_results/$JOB_NAME.xml

set +e

deactivate
