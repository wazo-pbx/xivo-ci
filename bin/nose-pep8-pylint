#!/bin/bash

usage() {
    echo "Usage: $0 [-r <nose|trial>] package_name [module_path]" >&2
    exit 1
}

while getopts ":r:" opt; do
    case "$opt" in
        r)
            runner="$OPTARG"
            if [ "$runner" != "nose" -a "$runner" != "trial" ]; then
                usage
            fi
            ;;
        *)
            usage
            ;;
    esac
done
shift $((OPTIND-1))

package_name="$1"
package_path="${2:-.}"

if [ $# -lt 1 ]; then
    usage
fi

if [ "$runner" = "trial" ]; then
    trial --reporter=bwverbose $package_path/$package_name
    exit_code=$?
else
    nosetests --cover-package=$package_name --with-xunit --with-coverage --cover-xml --cover-erase $package_path/$package_name
    exit_code=$?
fi

pep8 --repeat --ignore E320,E501 $package_path/$package_name > pep8.txt
PYTHONPATH=$package_path:$PYTHONPATH pylint-patcher --rcfile=/usr/share/xivo-ci/pylintrc $package_name > pylint.txt

exit $exit_code
