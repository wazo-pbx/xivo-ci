#!/bin/bash

usage() {
    echo "Usage: $0 [-v <virtualenv>] [-r <nose|trial>] package_name [module_path]" >&2
    echo "virtualenv defaults to 'xivo'"
    exit 1
}

while getopts ":r:v:" opt; do
    case "$opt" in
        r)
            runner="$OPTARG"
            if [ "$runner" != "nose" -a "$runner" != "trial" ]; then
                usage
            fi
            ;;
        v)
            virtualenv="$OPTARG"
            ;;
        *)
            usage
            ;;
    esac
done
shift $((OPTIND-1))

package_name="$1"
package_path="${2:-.}"
: ${virtualenv:="xivo"}

source ci-workon "$virtualenv"

set -e
pip install --upgrade -r requirements.txt
if [ -f test-requirements.txt ]; then
    pip install --upgrade -r test-requirements.txt
fi
set +e

if [ "$runner" = "trial" ]; then
    pip install --upgrade twisted
    trial --reporter=bwverbose "$package_path/$package_name"
    exit_code=$?
else
    pip install --upgrade nose coverage
    nosetests --cover-package="$package_name" --with-xunit --with-coverage --cover-xml --cover-erase "$package_path/$package_name"
    exit_code=$?
fi

pip install --upgrade pep8 pylint-patcher
pep8 --repeat --ignore E320,E501 $package_path/$package_name > pep8.txt || true
PYTHONPATH=$package_path:$PYTHONPATH pylint-patcher --rcfile=/usr/share/xivo-ci/pylintrc $package_name > pylint.txt || true

deactivate

exit $exit_code
