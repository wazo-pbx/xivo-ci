#!/bin/bash

package="$1"
distribution="$2"
mirror_url="$3"

ARCH="$(dpkg-architecture -qDEB_BUILD_ARCH)"
mirror_uri="dists/${distribution}/main/binary-${ARCH}/Packages"
existing_version="$(wget -qO- ${mirror_url}/${mirror_uri} | grep -A 2 "^Package: ${package}" | grep '^Version:' | head -n1 | awk '{print $2}')"
changelog=$(head -1 debian/changelog)

if [[ "$changelog" =~ \((.*)\) ]] ; then
    source_version=${BASH_REMATCH[1]}
fi

if [[ "$existing_version" =~ .*-(.*) ]] ; then
    debian="-$(expr ${BASH_REMATCH[1]} + 1)"
else
    debian=-1
fi

version=${source_version}${debian}

echo $version

